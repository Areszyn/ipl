<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Streaming | Exclusive on Telegram</title>
  <script src="https://content.jwplatform.com/libraries/KB5zFt7A.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0088cc;
      --dark: #121212;
      --darker: #0a0a0a;
      --text: #ffffff;
      --text-muted: rgba(255,255,255,0.7);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--darker);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    #player {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      display: none;
      background: #000;
    }

    #html5Player {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 2;
      display: none;
      background: #000;
    }

    .premium-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10,10,10,0.95);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .premium-card {
      background: rgba(30,30,30,0.95);
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      max-width: 500px;
      text-align: center;
    }

    .logo {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 15px;
      color: var(--primary);
    }

    .tagline {
      font-size: 15px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    .btn {
      padding: 14px 28px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      margin: 10px;
      display: inline-block;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .mini-app-message {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--darker);
      z-index: 2000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      text-align: center;
    }

    .error-message {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--darker);
      z-index: 3000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #ff5555;
      text-align: center;
      padding: 20px;
    }

    @media (max-width: 480px) {
      .premium-card {
        padding: 20px;
      }
      h1 {
        font-size: 22px;
      }
    }
  </style>
</head>
<body>

<div id="player"></div>
<div id="html5Player"></div>
<div class="error-message" id="errorMessage"></div>

<div class="premium-overlay" id="premiumOverlay">
  <div class="premium-card">
    <div class="logo">
      <i class="fas fa-crown"></i>
    </div>
    <h1>Premium Streaming</h1>
    <p class="tagline">Join our channel for exclusive live streams</p>
    <button class="btn btn-primary" id="joinBtn">
      <i class="fab fa-telegram"></i> Join Channel
    </button>
  </div>
</div>

<div class="mini-app-message" id="miniAppMessage">
  <div class="premium-card">
    <div class="logo">
      <i class="fab fa-telegram"></i>
    </div>
    <h1>Open in Telegram</h1>
    <p class="tagline">This content is only available in the Telegram app</p>
    <a href="https://t.me/neprosz" class="btn btn-primary">
      <i class="fab fa-telegram"></i> Open App
    </a>
  </div>
</div>

<script>
  // Configuration
  const config = {
    streamUrl: "https://m3u8x2.cloudycx.net/media/hls/files/index.m3u8",
    channelUrl: "https://t.me/neprosz",
    useHTML5Player: /iPhone|iPad|iPod/i.test(navigator.userAgent) // Use HTML5 for iOS
  };

  // Initialize
  document.addEventListener('DOMContentLoaded', init);

  function init() {
    if (!isTelegram()) {
      showMiniAppMessage();
      return;
    }

    setupTelegramApp();
    initPlayer();
    setupButtons();
    
    if (hasJoinedBefore()) {
      startPlayback();
    }
  }

  function isTelegram() {
    try {
      return (
        window.Telegram?.WebApp?.initData || 
        navigator.userAgent.includes('Telegram')
      );
    } catch (e) {
      return false;
    }
  }

  function setupTelegramApp() {
    try {
      if (window.Telegram?.WebApp) {
        Telegram.WebApp.expand();
        Telegram.WebApp.enableClosingConfirmation();
        Telegram.WebApp.BackButton.hide();
      }
    } catch (e) {
      console.error("Telegram WebApp setup error:", e);
    }
  }

  function initPlayer() {
    if (config.useHTML5Player) {
      initHTML5Player();
    } else {
      initJWPlayer();
    }
  }

  function initJWPlayer() {
    try {
      const player = jwplayer("player").setup({
        file: config.streamUrl,
        width: "100%",
        height: "100%",
        autostart: false
      });

      player.on('ready', () => {
        document.getElementById('player').style.display = 'block';
      });

      player.on('error', () => {
        fallbackToHTML5();
      });

    } catch (e) {
      console.error("JWPlayer init failed:", e);
      fallbackToHTML5();
    }
  }

  function initHTML5Player() {
    const playerEl = document.getElementById('html5Player');
    playerEl.innerHTML = `
      <video playsinline webkit-playsinline controls autoplay 
             style="width:100%;height:100%;object-fit:contain">
        <source src="${config.streamUrl}" type="application/x-mpegURL">
      </video>
    `;
    
    const video = playerEl.querySelector('video');
    video.onerror = () => {
      showError("Stream unavailable. Please try again later.");
    };
    
    video.onplaying = () => {
      playerEl.style.display = 'block';
    };
  }

  function fallbackToHTML5() {
    console.log("Falling back to HTML5 player");
    config.useHTML5Player = true;
    document.getElementById('player').style.display = 'none';
    initHTML5Player();
  }

  function setupButtons() {
    document.getElementById('joinBtn').addEventListener('click', () => {
      try {
        Telegram.WebApp.openTelegramLink(config.channelUrl);
      } catch (e) {
        window.open(config.channelUrl, '_blank');
      }
      setJoinedStatus();
      startPlayback();
    });
  }

  function hasJoinedBefore() {
    return localStorage.getItem('tgChannelJoined') === 'true';
  }

  function setJoinedStatus() {
    localStorage.setItem('tgChannelJoined', 'true');
  }

  function startPlayback() {
    document.getElementById('premiumOverlay').style.display = 'none';
    
    if (config.useHTML5Player) {
      const video = document.querySelector('#html5Player video');
      if (video) {
        video.play().catch(e => {
          console.error("Autoplay failed:", e);
          video.controls = true;
        });
      }
    } else {
      try {
        jwplayer().play(true);
      } catch (e) {
        fallbackToHTML5();
      }
    }
  }

  function showMiniAppMessage() {
    document.getElementById('miniAppMessage').style.display = 'flex';
    document.getElementById('premiumOverlay').style.display = 'none';
  }

  function showError(message) {
    const errorEl = document.getElementById('errorMessage');
    errorEl.innerHTML = `
      <div class="premium-card">
        <div class="logo">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h1>${message}</h1>
        <button class="btn btn-primary" onclick="window.location.reload()">
          <i class="fas fa-sync-alt"></i> Reload
        </button>
      </div>
    `;
    errorEl.style.display = 'flex';
  }
</script>
</body>
</html>
